spec:
  inputs:
    project_name:
      description: 'Project name used for image naming'
    image_tag:
      description: 'Image tag for the image to scan'
    sbom_stage:
      default: 'test'
      description: 'Stage for the SBOM generation job'
---
generate_sbom:
  stage: $[[ inputs.sbom_stage ]]
  image: docker:28.0.4
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    LOCAL_IMAGE_NAME: "$[[ inputs.project_name ]]:$[[ inputs.image_tag ]]"
    DOCKER_HOST: tcp://docker:2375/  # Very important! Talk to DinD
    DOCKER_TLS_CERTDIR: ""           # Disable TLS for DinD (default GitLab behavior)
  before_script:
    - apk add --no-cache curl
    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
  script:
    - echo "Generating SBOM for image $LOCAL_IMAGE_NAME"
    - syft "docker:$LOCAL_IMAGE_NAME" -o spdx-json > sbom.json
    - echo "SBOM summary:"
    - cat sbom.json
  needs:
    - build_image
  artifacts:
    paths:
      - sbom.json